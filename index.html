<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Contribution Logger (Cloud)</title>
    <!-- Use Tailwind CSS for a modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Chart.js for creating the dashboard visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Import the Supabase client library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-button {
            cursor: pointer;
            display: inline-block;
        }
        /* Hide elements by default */
        .modal {
            display: none;
        }
        /* New Toast Styles */
        #toast-notification.show {
            display: block;
            transform: translateX(0);
            opacity: 1;
        }
        .toast-success {
            background-color: #28a745; /* Green */
        }
        .toast-error {
            background-color: #dc3545; /* Red */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-5 right-5 z-50 p-4 rounded-md shadow-lg text-white max-w-xs" style="display: none; transform: translateX(100%); transition: transform 0.3s ease, opacity 0.3s ease; opacity: 0;">
        <p id="toast-message"></p>
    </div>

    <!-- Authentication Section (Shown when logged out) -->
    <div id="auth-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md w-full">
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">Work Logger Login</h2>
            <p class="text-center text-gray-600 mb-6">Enter your email to receive a secure magic link to log in. No password required.</p>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email-input" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="email-input" placeholder="you@example.com" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button id="login-btn" type="submit" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-300">
                    Send Magic Link
                </button>
            </form>
            <p id="check-email-msg" class="text-center text-green-600 mt-4" style="display: none;">
                Check your email for the magic link!
            </p>
        </div>
    </div>

    <!-- Main Application (Shown when logged in) -->
    <div id="app-section" class="container mx-auto p-4 md:p-8 max-w-7xl" style="display: none;">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-gray-900">Work Contribution Logger</h1>
                <p id="user-email" class="text-lg text-gray-600 mt-2">Logged in as: </p>
            </div>
            <button id="logout-btn" class="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-300">
                Logout
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Section: Form and Dashboard -->
            <div class="lg-col-span-1 flex flex-col gap-8">
                <!-- Log Entry Form -->
                <section id="form-section" class="bg-white p-6 rounded-2xl shadow-lg transition-all duration-300">
                    <h2 id="formTitle" class="text-2xl font-semibold mb-4 text-gray-800">Add New Log</h2>
                    <form id="logForm" class="space-y-4">
                        <input type="hidden" id="logId">
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="project" class="block text-sm font-medium text-gray-700">Project / Category</label>
                            <input type="text" id="project" placeholder="e.g., 'Project Phoenix'" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="task" class="block text-sm font-medium text-gray-700">Task Description</label>
                            <textarea id="task" rows="3" placeholder="What did you accomplish?" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea id="notes" rows="2" placeholder="e.g., 'Fixed critical bug P-123'" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        
                        <div class="flex items-center gap-4 pt-2">
                            <button type="submit" id="submitBtn" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-300">Add Log</button>
                            <button type="button" id="cancelBtn" style="display: none;" class="w-full text-white bg-gray-500 hover:bg-gray-600 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-300">Cancel</button>
                        </div>
                    </form>
                </section>
                
                <!-- Dashboard Visualization -->
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Dashboard</h2>
                    <canvas id="projectChart"></canvas>
                </section>
            </div>

            <!-- Right Section: Activity Log -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Activity Log</h2>
                
                <div class="flex flex-wrap gap-4 mb-4 border-b pb-4 border-gray-200">
                    <button id="exportBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Export to CSV
                    </button>
                    <label for="fileInput" class="file-input-button inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        Import from CSV
                    </label>
                    <input type="file" id="fileInput" accept=".csv" class="hidden">
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Date</th>
                                <th scope="col" class="px-6 py-3">Project</th>
                                <th scope="col" class="px-6 py-3">Task</th>
                                <th scope="col" class="px-6 py-3 hidden md:table-cell">Notes</th>
                                <th scope="col" class="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody">
                            <!-- JS will populate this section -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" style="display: none;" class="modal fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-backdrop fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white p-6 rounded-lg shadow-lg z-10 max-w-sm w-full">
            <h3 class="text-lg font-medium text-gray-900">Confirm Action</h3>
            <p id="confirm-message" class="mt-2 text-sm text-gray-600"></p>
            <div class="mt-4 flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- Supabase Client Initialization ---
            const supabaseUrl = 'https://vkvzaiorfyqwdiljkicv.supabase.co';
            const supabaseAnonKey = 'eyJhbGciOiJIJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrdnphaW9yZnlxd2RpbGpraWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMjgxNTcsImV4cCI6MjA3NjgwNDE1N30.og85B-n0_eM7IyOqGm9tn2GbSX6f3ggGB4IC-Zo5yuo';
            
            const { createClient } = window.supabase; 
            const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

            // --- DOM Element Selectors ---
            const authSection = document.getElementById('auth-section');
            const appSection = document.getElementById('app-section');
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('email-input');
            const loginBtn = document.getElementById('login-btn');
            const checkEmailMsg = document.getElementById('check-email-msg');
            const userEmail = document.getElementById('user-email');
            const logoutBtn = document.getElementById('logout-btn');

            const logForm = document.getElementById("logForm");
            const submitBtn = document.getElementById("submitBtn");
            const cancelBtn = document.getElementById("cancelBtn");
            const formTitle = document.getElementById("formTitle");
            
            const logIdInput = document.getElementById("logId");
            const dateInput = document.getElementById("date");
            const projectInput = document.getElementById("project");
            const taskInput = document.getElementById("task");
            const notesInput = document.getElementById("notes");
            
            const logTableBody = document.getElementById("logTableBody");
            const exportBtn = document.getElementById("exportBtn");
            const fileInput = document.getElementById("fileInput");
            
            const ctx = document.getElementById('projectChart').getContext('2d');
            let projectChart;

            // Modals & Toast
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            let toastTimer;
            
            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            let confirmCallback = null;

            // --- Application State ---
            let logs = []; // Local cache of database logs
            let editingId = null;
            let currentUser = null;
            let realtimeChannel = null; // To hold our real-time channel

            // --- Modal & Toast Functions ---
            function showNotification(message, isError = false) {
                // Clear any existing timer
                if (toastTimer) clearTimeout(toastTimer);

                toastMessage.textContent = message;
                
                // Set color
                toast.classList.remove('toast-success', 'toast-error', 'show');
                if (isError) {
                    toast.classList.add('toast-error');
                } else {
                    toast.classList.add('toast-success');
                }
                
                // Show
                toast.style.display = 'block';
                // Need to trigger reflow for CSS transition
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10); // 10ms delay to ensure transition triggers

                // Auto-hide after 3 seconds
                toastTimer = setTimeout(() => {
                    toast.classList.remove('show');
                    // Wait for transition to end before hiding
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 300); // 300ms matches CSS transition time
                }, 3000);
            }

            function showConfirm(message, onConfirm) {
                confirmMessage.textContent = message;
                confirmModal.style.display = 'flex';
                confirmCallback = onConfirm;
            }

            confirmOkBtn.addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                confirmModal.style.display = 'none';
                confirmCallback = null;
            });

            confirmCancelBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
                confirmCallback = null;
            });

            // --- Authentication Functions ---

            async function handleLogin(e) {
                e.preventDefault();
                const email = emailInput.value.trim();
                loginBtn.disabled = true;
                loginBtn.textContent = "Sending...";
                
                const { error } = await supabaseClient.auth.signInWithOtp({ 
                    email: email,
                    options: {
                        // This tells Supabase where to redirect back to
                        emailRedirectTo: window.location.href
                    }
                });

                if (error) {
                    showNotification(`Error: ${error.message}`, true);
                    loginBtn.disabled = false;
                    loginBtn.textContent = "Send Magic Link";
                } else {
                    checkEmailMsg.style.display = "block";
                    showNotification("Magic link sent! Please check your email.");
                }
            }

            async function handleLogout() {
                await supabaseClient.auth.signOut();
                // The onAuthStateChange listener will handle the UI change
            }
            
            // --- Core Data Functions (CRUD) ---

            async function fetchLogs() {
                if (!currentUser) return;
                
                const { data, error } = await supabaseClient
                    .from('logs')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('date', { ascending: false });

                if (error) {
                    showNotification(`Error fetching logs: ${error.message}`, true);
                } else {
                    logs = data;
                    renderTable();
                    renderDashboard();
                }
            }

            async function handleFormSubmit(e) {
                e.preventDefault();
                submitBtn.disabled = true; // Disable button immediately
                submitBtn.textContent = editingId ? "Updating..." : "Uploading...";

                const logData = {
                    date: dateInput.value,
                    project: projectInput.value.trim(),
                    task: taskInput.value.trim(),
                    notes: notesInput.value.trim(),
                    user_id: currentUser.id // Ensure user_id is set
                };
                
                if (!logData.date || !logData.project || !logData.task) {
                    showNotification("Please fill out Date, Project, and Task Description.", true);
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingId ? "Update Log" : "Add Log";
                    return;
                }

                if (editingId) {
                    // Update existing log - NO .select()
                    const { error: updateError } = await supabaseClient
                        .from('logs')
                        .update(logData)
                        .eq('id', editingId)
                        .eq('user_id', currentUser.id); // No .select()

                    // --- Reset button regardless of outcome ---
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Update Log";

                    if (updateError) {
                        console.error("Supabase Update Error:", updateError); // Log error for debugging
                        showNotification("Update log fail, contact dev", true);
                    } else {
                        // --- Update local list ON SUCCESS ---
                        // Create object with the known ID
                        const updatedLog = { ...logData, id: editingId }; 
                        const index = logs.findIndex(log => log.id == editingId);
                        if (index > -1) logs[index] = updatedLog; // Use the data we sent
                        
                        renderTable();
                        renderDashboard();
                        setAddMode();
                        showNotification("Update successful!");
                    }
                } else {
                    // Add new log - NO .select()
                    const { error: insertError } = await supabaseClient
                        .from('logs')
                        .insert(logData); // Just insert

                    // --- Reset button regardless of outcome ---
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Add Log";

                    if (insertError) {
                        console.error("Supabase Insert Error:", insertError); // Log error for debugging
                        showNotification("Add log fail, contact dev", true);
                    } else {
                         // --- Fetch fresh data ON SUCCESS ---
                         // This is the most reliable way after an insert without .select()
                         await fetchLogs(); 
                         
                         setAddMode();
                         showNotification("Logged successful!"); 
                    }
                }
            }


            async function handleDelete(id) {
                showConfirm("Are you sure you want to delete this log entry?", async () => {
                    const { error } = await supabaseClient
                        .from('logs')
                        .delete()
                        .eq('id', id)
                        .eq('user_id', currentUser.id);

                    if (error) {
                        showNotification(`Error deleting log: ${error.message}`, true);
                    } else {
                        // **FIXED:** Manually remove the log from our local list
                        logs = logs.filter(log => log.id != id);
                        renderTable();
                        renderDashboard();
                        showNotification("Log deleted.");
                    }
                });
            }

            // --- UI/Helper Functions ---
            
            function setAddMode() {
                logForm.reset();
                editingId = null;
                logIdInput.value = "";
                formTitle.textContent = "Add New Log";
                submitBtn.textContent = "Add Log";
                 // Ensure button is enabled when form resets
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                cancelBtn.style.display = "none";
                dateInput.valueAsDate = new Date();
            }

            function setEditMode(log) {
                editingId = log.id;
                logIdInput.value = log.id;
                dateInput.value = log.date;
                projectInput.value = log.project;
                taskInput.value = log.task;
                notesInput.value = log.notes;

                formTitle.textContent = "Edit Log Entry";
                submitBtn.textContent = "Update Log";
                 // Ensure button is enabled when entering edit mode
                submitBtn.disabled = false; 
                submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                submitBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                cancelBtn.style.display = "block";
                document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
            }

            function renderTable() {
                logTableBody.innerHTML = "";
                
                if (logs.length === 0) {
                    logTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No logs found. Add one to get started!</td></tr>';
                    return;
                }

                // **FIXED:** We must manually sort the local list now
                const sortedLogs = [...logs].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedLogs.forEach(log => {
                    const tr = document.createElement("tr");
                    tr.className = "bg-white border-b";
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${log.date}</td>
                        <td class="px-6 py-4">${escapeHTML(log.project)}</td>
                        <td class="px-6 py-4 max-w-xs truncate">${escapeHTML(log.task)}</td>
                        <td class="px-6 py-4 hidden md:table-cell max-w-xs truncate">${escapeHTML(log.notes)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="font-medium text-yellow-500 hover:underline mr-3 edit-btn" data-id="${log.id}">Edit</button>
                            <button class="font-medium text-red-600 hover:underline delete-btn" data-id="${log.id}">Delete</button>
                        </td>
                    `;
                    logTableBody.appendChild(tr);
                });
            }
            
            function renderDashboard() {
                const projectData = logs.reduce((acc, log) => {
                    // **FIXED:** Trim whitespace from the project name
                    const project = log.project ? log.project.trim() : "Uncategorized";
                    const cleanProject = project || "Uncategorized";
                    acc[cleanProject] = (acc[cleanProject] || 0) + 1;
                    return acc;
                }, {});

                const labels = Object.keys(projectData);
                const data = Object.values(projectData);

                if (projectChart) projectChart.destroy();

                projectChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Entries by Project',
                            data: data,
                            backgroundColor: [
                                '#4f46e5', '#db2777', '#16a34a', '#f59e0b', '#8b5cf6',
                                '#0d9488', '#d97706', '#4b5563', '#64748b', '#ef4444'
                            ],
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: false }
                        }
                    }
                });
            }
            
            function escapeHTML(str) {
                if (str == null) return '';
                const p = document.createElement("p");
                p.textContent = str;
                return p.innerHTML;
            }
            
            function formatCSVField(field) {
                let str = String(field == null ? "" : field);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    str = `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            }

            // --- Event Handlers ---
            
            loginForm.addEventListener("submit", handleLogin);
            logoutBtn.addEventListener("click", handleLogout);

            function handleTableClick(e) {
                const target = e.target;
                const id = target.getAttribute("data-id");
                if (!id) return;

                if (target.classList.contains("edit-btn")) {
                    const logToEdit = logs.find(log => log.id == id); // Use '==' for potential type diff
                    if (logToEdit) setEditMode(logToEdit);
                } else if (target.classList.contains("delete-btn")) {
                    handleDelete(id);
                }
            }

            function handleExport() {
                if (logs.length === 0) {
                    showNotification("No logs to export.", true);
                    return;
                }
                const headers = ["date", "project", "task", "notes"];
                let csvContent = headers.join(",") + "\n";

                logs.forEach(log => {
                    const row = headers.map(header => formatCSVField(log[header]));
                    csvContent += row.join(",") + "\n";
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `work_logs_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function handleImport(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        parseCSV(event.target.result);
                    } catch (error) {
                        showNotification("Error parsing CSV file: " + error.message, true);
                    }
                };
                reader.readAsText(file);
                fileInput.value = "";
            }

            async function parseCSV(text) {
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) {
                    showNotification("CSV file is empty or missing data rows.", true);
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const requiredHeaders = ['date', 'project', 'task'];
                if (!requiredHeaders.every(h => headers.includes(h))) {
                    showNotification(`CSV file is missing required headers: ${requiredHeaders.join(', ')}`, true);
                    return;
                }
                
                const logsToInsert = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const newLog = {};
                    headers.forEach((header, index) => {
                       newLog[header] = values[index]?.trim().replace(/^"|"$/g, '').replace(/""/g, '"') || '';
                    });
                    
                    if (newLog.date && newLog.project && newLog.task) {
                         logsToInsert.push({
                            date: newLog.date,
                            project: newLog.project,
                            task: newLog.task,
                            notes: newLog.notes || '',
                            user_id: currentUser.id
                         });
                    }
                }

                if (logsToInsert.length > 0) {
                    const { error } = await supabaseClient.from('logs').insert(logsToInsert);
                    if (error) {
                        showNotification(`Error importing logs: ${error.message}`, true);
                    } else {
                        showNotification(`Import complete. ${logsToInsert.length} new logs added.`);
                        // **FIXED:** Manually refresh the log list
                        fetchLogs();
                    }
                } else {
                    showNotification("No valid logs found in file to import.", true);
                }
            }
            
            // --- Authentication & Initial Load ---
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    currentUser = session.user;
                    userEmail.textContent = `Logged in as: ${currentUser.email}`;
                    authSection.style.display = "none";
                    appSection.style.display = "block";
                    await fetchLogs();
                    
                    if (!realtimeChannel) {
                        realtimeChannel = supabaseClient.channel('public_logs')
                            .on('postgres_changes', { event: '*', schema: 'public', table: 'logs' }, payload => {
                                if (payload.new?.user_id === currentUser.id || payload.old?.user_id === currentUser.id) {
                                    // Slight delay to allow replication
                                    setTimeout(fetchLogs, 500); 
                                }
                            })
                            .subscribe();
                    }
                } else {
                    currentUser = null;
                    logs = [];
                    authSection.style.display = "flex";
                    appSection.style.display = "none";
                    renderTable();
                    renderDashboard();
                    if (realtimeChannel) {
                        supabaseClient.removeChannel(realtimeChannel);
                        realtimeChannel = null;
                    }
                }
            });

            // --- Event Listeners Initialization ---
            logForm.addEventListener("submit", handleFormSubmit);
            logTableBody.addEventListener("click", handleTableClick);
            cancelBtn.addEventListener("click", setAddMode);
            exportBtn.addEventListener("click", handleExport);
            fileInput.addEventListener("change", handleImport);
            
            // --- Initial Form Setup ---
            setAddMode();
        });
    </script>

</body>
</html>

