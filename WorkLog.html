<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Contribution Logger</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase JS Client (v2) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-button {
            cursor: pointer;
            display: inline-block;
        }
        /* Hide elements by default */
        #app-container, #cancelBtn, .modal {
            display: none;
        }
        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Auth Container (Login Screen) -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md w-full">
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">Work Logger Login</h2>
            <p class="text-center text-gray-600 mb-6">Enter your email to receive a secure magic link to log in. No password required.</p>
            <form id="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="email-input" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="email-input" required placeholder="you@example.com" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" id="login-btn" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-3 text-center transition-colors duration-300">
                        Send Magic Link
                    </button>
                </div>
            </form>
            <p id="auth-message" class="text-center text-sm mt-4"></p>
        </div>
    </div>

    <!-- Main App Container (Hidden by default) -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <!-- App Header -->
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-gray-900">Work Contribution Logger</h1>
                <p class="text-lg text-gray-600 mt-2">Your data is securely saved in the cloud.</p>
            </div>
            <div class="text-right">
                <p id="user-email-display" class="text-sm text-gray-600 mb-2"></p>
                <button id="logout-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Logout
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Section: Form and Dashboard -->
            <div class="lg-col-span-1 flex flex-col gap-8">
                <!-- Log Entry Form -->
                <section id="form-section" class="bg-white p-6 rounded-2xl shadow-lg transition-all duration-300">
                    <h2 id="formTitle" class="text-2xl font-semibold mb-4 text-gray-800">Add New Log</h2>
                    <form id="logForm" class="space-y-4">
                        <input type="hidden" id="logId">
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="project" class="block text-sm font-medium text-gray-700">Project / Category</label>
                            <input type="text" id="project" placeholder="e.g., 'Project Phoenix'" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="task" class="block text-sm font-medium text-gray-700">Task Description</label>
                            <textarea id="task" rows="3" placeholder="What did you accomplish?" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea id="notes" rows="2" placeholder="e.g., 'Fixed critical bug P-123'" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div class="flex items-center gap-4 pt-2">
                            <button type="submit" id="submitBtn" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-300">Add Log</button>
                            <button type="button" id="cancelBtn" class="w-full text-white bg-gray-500 hover:bg-gray-600 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-300">Cancel</button>
                        </div>
                    </form>
                </section>
                
                <!-- Dashboard Visualization -->
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Dashboard</h2>
                    <canvas id="projectChart"></canvas>
                </section>
            </div>

            <!-- Right Section: Activity Log -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Activity Log</h2>
                <div class="flex flex-wrap gap-4 mb-4 border-b pb-4 border-gray-200">
                    <button id="exportBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Export to CSV
                    </button>
                    <label for="fileInput" class="file-input-button inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Import from CSV
                    </label>
                    <input type="file" id="fileInput" accept=".csv" class="hidden">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Date</th>
                                <th scope="col" class="px-6 py-3">Project</th>
                                <th scope="col" class="px-6 py-3">Task</th>
                                <th scope="col" class="px-6 py-3 hidden md:table-cell">Notes</th>
                                <th scope="col" class="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody">
                            <!-- JS will populate this section -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4"> <!-- Removed 'flex' -->
        <div class="modal-backdrop fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white p-6 rounded-lg shadow-lg z-10 max-w-sm w-full">
            <h3 id="notification-title" class="text-lg font-medium text-gray-900">Notification</h3>
            <p id="notification-message" class="mt-2 text-sm text-gray-600"></p>
            <button id="notification-ok-btn" class="mt-4 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">OK</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4"> <!-- Removed 'flex' -->
        <div class="modal-backdrop fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white p-6 rounded-lg shadow-lg z-10 max-w-sm w-full">
            <h3 class="text-lg font-medium text-gray-900">Confirm Action</h3>
            <p id="confirm-message" class="mt-2 text-sm text-gray-600"></p>
            <div class="mt-4 flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- Supabase Client Initialization ---
            const SUPABASE_URL = 'https://vkvzaiorfyqwdiljkicv.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrdnphaW9yZnlxd2RpbGpraWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMjgxNTcsImV4cCI6MjA3NjgwNDE1N30.og85B-n0_eM7IyOqGm9tn2GbSX6f3ggGB4IC-Zo5yuo';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // --- DOM Selectors ---
            // Auth
            const authContainer = document.getElementById("auth-container");
            const appContainer = document.getElementById("app-container");
            const loginForm = document.getElementById("login-form");
            const emailInput = document.getElementById("email-input");
            const loginBtn = document.getElementById("login-btn");
            const authMessage = document.getElementById("auth-message");
            const userEmailDisplay = document.getElementById("user-email-display");
            const logoutBtn = document.getElementById("logout-btn");

            // App
            const logForm = document.getElementById("logForm");
            const submitBtn = document.getElementById("submitBtn");
            const cancelBtn = document.getElementById("cancelBtn");
            const formTitle = document.getElementById("formTitle");
            const logIdInput = document.getElementById("logId");
            const dateInput = document.getElementById("date");
            const projectInput = document.getElementById("project");
            const taskInput = document.getElementById("task");
            const notesInput = document.getElementById("notes");
            const logTableBody = document.getElementById("logTableBody");
            const exportBtn = document.getElementById("exportBtn");
            const fileInput = document.getElementById("fileInput");
            
            // Chart
            const ctx = document.getElementById('projectChart').getContext('2d');
            let projectChart;

            // Modals
            const notificationModal = document.getElementById('notification-modal');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            const notificationOkBtn = document.getElementById('notification-ok-btn');
            
            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            // --- Application State ---
            let logs = [];
            let user = null;
            let editingId = null;
            let realtimeChannel = null;
            let confirmCallback = null;

            // --- Modal Functions ---
            function showNotification(message, isError = false) {
                notificationTitle.textContent = isError ? 'Error' : 'Notification';
                notificationMessage.textContent = message;
                notificationModal.style.display = 'flex';
            }

            notificationOkBtn.addEventListener('click', () => {
                notificationModal.style.display = 'none';
            });

            function showConfirm(message, onConfirm) {
                confirmMessage.textContent = message;
                confirmModal.style.display = 'flex';
                confirmCallback = onConfirm;
            }

            confirmOkBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                confirmModal.style.display = 'none';
                confirmCallback = null;
            });

            confirmCancelBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
                confirmCallback = null;
            });

            // --- Authentication Functions ---
            async function handleLogin(e) {
                e.preventDefault();
                const email = emailInput.value.trim();
                loginBtn.disabled = true;
                loginBtn.textContent = "Sending...";
                
                const { error } = await supabase.auth.signInWithOtp({ 
                    email: email,
                    options: {
                        // Tell Supabase to redirect back to this exact page
                        emailRedirectTo: window.location.href
                    }
                });

                if (error) {
                    showNotification(`Error: ${error.message}`, true);
                } else {
                    authMessage.textContent = 'Check your email for the magic link!';
                    authMessage.classList.add('text-green-600');
                }
                loginBtn.disabled = false;
                loginBtn.textContent = "Send Magic Link";
            }

            async function handleLogout() {
                await supabase.auth.signOut();
            }

            // This is the core function that manages app state
            async function checkUserSession() {
                supabase.auth.onAuthStateChanged((event, session) => {
                    if (session) {
                        // User is logged in
                        user = session.user;
                        appContainer.style.display = 'block';
                        authContainer.style.display = 'none';
                        userEmailDisplay.textContent = user.email;
                        loadLogs();
                        subscribeToChanges();
                    } else {
                        // User is logged out
                        user = null;
                        appContainer.style.display = 'none';
                        authContainer.style.display = 'flex';
                        userEmailDisplay.textContent = '';
                        logs = [];
                        renderTable();
                        renderDashboard();
                        if (realtimeChannel) {
                            supabase.removeChannel(realtimeChannel);
                            realtimeChannel = null;
                        }
                    }
                });
            }

            // --- Real-time Function ---
            function subscribeToChanges() {
                if (realtimeChannel) {
                    supabase.removeChannel(realtimeChannel);
                }

                realtimeChannel = supabase.channel('public:logs')
                    .on('postgres_changes', { 
                        event: '*', 
                        schema: 'public', 
                        table: 'logs',
                        filter: `user_id=eq.${user.id}` // Only get changes for this user
                    }, 
                    (payload) => {
                        console.log('Realtime change received!', payload);
                        if (payload.eventType === 'INSERT') {
                            logs.unshift(payload.new);
                        }
                        if (payload.eventType === 'UPDATE') {
                            const index = logs.findIndex(log => log.id === payload.new.id);
                            if (index > -1) logs[index] = payload.new;
                        }
                        if (payload.eventType === 'DELETE') {
                            logs = logs.filter(log => log.id !== payload.old.id);
                        }
                        // Re-sort and re-render
                        logs.sort((a, b) => new Date(b.date) - new Date(a.date));
                        renderTable();
                        renderDashboard();
                    })
                    .subscribe();
            }

            // --- Core App Functions ---
            
            async function loadLogs() {
                if (!user) return;
                
                const { data, error } = await supabase
                    .from('logs')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('date', { ascending: false });

                if (error) {
                    showNotification(`Error loading logs: ${error.message}`, true);
                } else {
                    logs = data;
                    renderTable();
                    renderDashboard();
                }
            }
            
            function setAddMode() {
                logForm.reset();
                editingId = null;
                logIdInput.value = "";
                formTitle.textContent = "Add New Log";
                submitBtn.textContent = "Add Log";
                submitBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                cancelBtn.style.display = "none";
                dateInput.valueAsDate = new Date();
            }

            function setEditMode(log) {
                editingId = log.id;
                logIdInput.value = log.id;
                dateInput.value = log.date;
                projectInput.value = log.project;
                taskInput.value = log.task;
                notesInput.value = log.notes;

                formTitle.textContent = "Edit Log Entry";
                submitBtn.textContent = "Update Log";
                submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                submitBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                cancelBtn.style.display = "block";
                
                document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
            }

            function renderTable() {
                logTableBody.innerHTML = "";
                if (logs.length === 0) {
                    logTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No logs found. Add one to get started!</td></tr>';
                    return;
                }
                logs.forEach(log => {
                    const tr = document.createElement("tr");
                    tr.className = "bg-white border-b";
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${log.date}</td>
                        <td class="px-6 py-4">${escapeHTML(log.project)}</td>
                        <td class="px-6 py-4 max-w-xs truncate">${escapeHTML(log.task)}</td>
                        <td class="px-6 py-4 hidden md:table-cell max-w-xs truncate">${escapeHTML(log.notes)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="font-medium text-yellow-500 hover:underline mr-3 edit-btn" data-id="${log.id}">Edit</button>
                            <button class="font-medium text-red-600 hover:underline delete-btn" data-id="${log.id}">Delete</button>
                        </td>
                    `;
                    logTableBody.appendChild(tr);
                });
            }
            
            function renderDashboard() {
                const projectData = logs.reduce((acc, log) => {
                    const project = log.project || "Uncategorized";
                    acc[project] = (acc[project] || 0) + 1;
                    return acc;
                }, {});

                const labels = Object.keys(projectData);
                const data = Object.values(projectData);

                if (projectChart) projectChart.destroy();
                projectChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Entries by Project',
                            data: data,
                            backgroundColor: ['#4f46e5', '#db2777', '#16a34a', '#f59e0b', '#8b5cf6', '#0d9488', '#d97706', '#4b5563'],
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'top' } } }
                });
            }
            
            function escapeHTML(str) {
                const p = document.createElement("p");
                p.textContent = str;
                return p.innerHTML;
            }
            
            function formatCSVField(field) {
                let str = String(field == null ? "" : field);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    str = `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            }

            // --- Event Handlers ---

            async function handleFormSubmit(e) {
                e.preventDefault();
                if (!user) return;

                const logData = {
                    date: dateInput.value,
                    project: projectInput.value.trim(),
                    task: taskInput.value.trim(),
                    notes: notesInput.value.trim()
                };
                
                if (!logData.date || !logData.project || !logData.task) {
                    showNotification("Please fill out Date, Project, and Task Description.", true);
                    return;
                }
                
                submitBtn.disabled = true;
                let error;

                if (editingId) {
                    // Update existing log
                    const { error: updateError } = await supabase
                        .from('logs')
                        .update(logData)
                        .eq('id', editingId)
                        .eq('user_id', user.id);
                    error = updateError;
                } else {
                    // Add new log
                    const { error: insertError } = await supabase
                        .from('logs')
                        .insert({ ...logData, user_id: user.id });
                    error = insertError;
                }

                if (error) {
                    showNotification(`Error saving log: ${error.message}`, true);
                } else {
                    // Success! Real-time will update the table.
                    setAddMode();
                }
                submitBtn.disabled = false;
            }

            function handleTableClick(e) {
                const target = e.target;
                const id = target.getAttribute("data-id");
                if (!id) return;

                if (target.classList.contains("edit-btn")) {
                    const logToEdit = logs.find(log => log.id == id); // Use == for type coercion just in case
                    if (logToEdit) setEditMode(logToEdit);
                } else if (target.classList.contains("delete-btn")) {
                    showConfirm("Are you sure you want to delete this log entry?", async () => {
                        const { error } = await supabase
                            .from('logs')
                            .delete()
                            .eq('id', id)
                            .eq('user_id', user.id);
                        if (error) {
                            showNotification(`Error deleting log: ${error.message}`, true);
                        }
                        // Real-time will handle the table update
                    });
                }
            }

            function handleExport() {
                if (logs.length === 0) {
                    showNotification("No logs to export.", true);
                    return;
                }
                const headers = ["date", "project", "task", "notes"];
                let csvContent = headers.join(",") + "\n";
                logs.forEach(log => {
                    const row = headers.map(header => formatCSVField(log[header]));
                    csvContent += row.join(",") + "\n";
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `work_logs_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function handleImport(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        await parseAndInsertCSV(event.target.result);
                    } catch (error) {
                        showNotification(`Error importing file: ${error.message}`, true);
                    }
                };
                reader.readAsText(file);
                fileInput.value = "";
            }

            async function parseAndInsertCSV(text) {
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) {
                    showNotification("CSV file is empty or missing data rows.", true);
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const requiredHeaders = ['date', 'project', 'task'];
                if (!requiredHeaders.every(h => headers.includes(h))) {
                    showNotification(`CSV file must contain headers: ${requiredHeaders.join(', ')}`, true);
                    return;
                }
                
                const newLogs = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const newLog = { user_id: user.id };
                    headers.forEach((header, index) => {
                       newLog[header] = values[index]?.trim().replace(/^"|"$/g, '').replace(/""/g, '"') || '';
                    });
                    
                    if (newLog.date && newLog.project && newLog.task) {
                         newLogs.push(newLog);
                    }
                }

                if (newLogs.length > 0) {
                    const { error } = await supabase.from('logs').insert(newLogs);
                    if (error) {
                        showNotification(`Error inserting logs: ${error.message}`, true);
                    } else {
                        showNotification(`Successfully imported ${newLogs.length} logs.`);
                        // Real-time will handle the update
                    }
                } else {
                    showNotification("No new logs found in file to import.", true);
                }
            }

            // --- Event Listeners Initialization ---
            loginForm.addEventListener("submit", handleLogin);
            logoutBtn.addEventListener("click", handleLogout);
            logForm.addEventListener("submit", handleFormSubmit);
            logTableBody.addEventListener("click", handleTableClick);
            cancelBtn.addEventListener("click", setAddMode);
            exportBtn.addEventListener("click", handleExport);
            fileInput.addEventListener("change", handleImport);

            // --- Initial Application Load ---
            checkUserSession();
            setAddMode(); // Set default date
        });
    </script>

</body>
</html>

